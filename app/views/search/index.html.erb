<% content_for(:before_title) do %>
  <%= link_to('UK Parliament', root_path) %> / <%= link_to('Open data', root_path) %><br/>
  <div id="top"></div>
<% end %>

<% if Rails.env.development? %>
  <%#= render 'search/fragments/data', data: @associated_object_data, title: 'Associated object data' %>
  <%#= render 'search/fragments/data', data: @search_data.search, title: 'Search response' %>
  <%#= render 'search/fragments/data', data: @ses_data, title: 'SES results' %>
  <%#= render 'search/fragments/data', data: @search_data.facets, title: 'Facets' %>
  <%#= render 'search/fragments/data', data: @search_data.type_facets, title: 'Type facets' %>
  <%#= render 'search/fragments/data', data: @search_data.hierarchy_data, title: 'Hierarchy data' %>
  <%#= render 'search/fragments/data', data: @top_level, title: 'Hierarchy top level types' %>
  <%#= render 'search/fragments/data', data: @toggled_facets, title: 'Toggled facets' %>
  <%#= render 'search/fragments/data', data: request.params, title: 'All params' %>
<% end %>

<%= form_with url: search_url, method: :get, remote: true, id: 'search-form' do |f| %>
  <section id="search" class="content-section white-slim">
    <div class="search-grid-container">
      <%= f.text_field :query, class: 'grid-item', id: 'search-input', value: @search_data.query %>
      <%= f.submit 'New search', class: 'grid-item', id: 'search-button' %>
    </div>
  </section>
<% end %>

<% if @search_data.objects.blank? %>
  <section class="content-section white centered">
    <p>
      No results found for <strong><%= @search_data.query %></strong>. Please adjust your search query and try
      again.<br/>
      If you think this search should return results, please
      email <%= mail_to "parliamentarysearch@parliament.co.uk" %>.
    </p>
  </section>
<% else %>
  <section id="search-results">
    <div class="results-grid-container">
      <div class="filter-container" data-controller="expand-facet">
        <% unless request.params.dig(:filter).blank? %>
          <section class="applied-filters">
            <div class="applied-filter-container">
              <% request.params.dig(:filter).sort.each do |filter| %>
                <% filter.last.sort.each do |filter_value| %>
                  <div class="filter-wrapper">
                    <div class="filter">
                      <div class="top-row">
                        <span class="filter-name-label">
                          <%= filter_field_name(filter.first) %>
                        </span>
                        <span class="flex-spacer"></span>
                        <span class="filter-link">
                          <%= link_to sanitize("&#x2717;"), url_for(remove_filter_url(request.params, filter.first, filter_value)), class: 'modifiable-link' %>
                        </span>
                      </div>
                      <div class="bottom-row">
                        <div class="filter-name">
                          <%= object_display_name({ value: filter_field_value(filter, filter_value), field_name: filter.first }, singular: false) %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </section>
        <% end %>

        <section class="facet">
          <div>
            <div>
              <strong>Type</strong>
            </div>
            <div class="facets" data-controller="expand-types">
              <% @search_data.hierarchy_builder.top_level_types&.each do |top_level_type| %>
                <%= render 'hierarchy_layer', hash: top_level_type, id: top_level_type[:id], tier: 1, parent_id: 0 %>
              <% end %>
            </div>
          </div>
        </section>

        <% if year_filter.present? %>
          <% year_filter.each do |year| %>
            <section class="facet">
              <div>
                <div>
                  <strong>Date</strong>
                </div>
                <div class="facets">
                  <% @search_data.months.each_with_index do |month, index| %>
                    <div>
                      <%= link_to("#{month['val'].to_date.strftime("%B")} #{year} (#{month['count']})", url_for(apply_filter_url(request.params, "month", year + "-#{index + 1}")), class: "modifiable-link") %>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>
        <% else %>
          <% unless @search_data.years.blank? %>
            <section class="facet">
              <div>
                <div>
                  <strong>Date</strong>
                </div>
                <div class="facets">
                  <% @search_data.years[0..4].each do |year_data| %>
                    <div>
                      <%= link_to("#{year_data["val"].to_date.year} (#{year_data["count"]})", url_for(apply_filter_url(request.params, "year", year_data["val"].to_date.year)), class: "modifiable-link") %>
                    </div>
                  <% end %>
                  <% unless @search_data.years[5..].blank? %>
                    <details>
                      <summary>More</summary>
                      <% @search_data.years[5..].each do |year_data| %>
                        <div>
                          <%= link_to("#{year_data["val"].to_date.year} (#{year_data["count"]})", url_for(apply_filter_url(request.params, "year", year_data["val"].to_date.year)), class: "modifiable-link") %>
                        </div>
                      <% end %>
                    </details>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>
        <% end %>

        <% @search_data.facets.select { |h| ["legislature_ses", "session_t", "department_ses", "member_ses", "tablingMember_ses", "askingMember_ses", "leadMember_ses", "answeringMember_ses", "legislativeStage_ses", "legislationTitle_ses", "subject_ses"].include?(h.dig(:field_name)) }.each do |facet_field| %>
          <%= render 'filter_section', facet_field: format_facets(facet_field) %>
        <% end %>

        <%# @search_data.facets.select { |h| [].include?(h.dig(:field_name)) }.each do |facet_field| %>
        <%#= render 'filter_section', facet_field: format_facets(facet_field) %>
        <%# end %>
      </div>

      <div class="results-container" data-controller="detailed-results">
        <section class="search-control-panel">
          <div class="search-control-panel-row">
            <strong><%= number_to_delimited(@search_data.number_of_results, separator: ",") %><%= @search_data.number_of_results && @search_data.number_of_results > 1 ? " results" : " result" %></strong>
            <div class="flex-spacer"></div>
            <span class="search-control-panel-item">
              <span class="search-control-panel-label">Show detailed:</span>
              <% if @search_data.show_detailed? %>
                <span class="search-control-panel-current">
                On
                </span>
                <span class="search-control-panel-link">
                <%= link_to "Off", search_url(query: @search_data.query, filter: @search_data.filter, sort_by: @search_data.sort, results_per_page: @search_data.results_per_page, page: @search_data.current_page, expanded_types: @search_data.expanded_types, show_detailed: false), class: "modifiable-link" %>
                </span>
              <% else %>
                <span class="search-control-panel-link">
                <%= link_to "On", search_url(query: @search_data.query, filter: @search_data.filter, sort_by: @search_data.sort, results_per_page: @search_data.results_per_page, page: @search_data.current_page, expanded_types: @search_data.expanded_types, show_detailed: true), class: "modifiable-link" %>
                </span>
                <span class="search-control-panel-current">
                Off
                </span>
              <% end %>
            </span>

            <span class="search-control-panel-item">
              <label class="search-control-panel-label">
                <span>Results:</span>
              </label>
              <% [10, 20, 50, 100].each do |per_page_option| %>
                <% if @search_data.results_per_page == per_page_option %>
                <span class="search-control-panel-current">
                  <%= per_page_option %>
                </span>
                <% else %>
                <span class="search-control-panel-link">
                  <%= link_to per_page_option, search_url(query: @search_data.query, filter: @search_data.filter, sort_by: @search_data.sort, results_per_page: per_page_option, page: @search_data.current_page, expanded_types: @search_data.expanded_types, show_detailed: @search_data.show_detailed), class: "modifiable-link" %>
                </span>
                <% end %>
              <% end %>
            </span>

            <span class="search-control-panel-item">
              <label class="search-control-panel-label">
                <span>Sort by:</span>
              </label>
              <% if @search_data.sort == "date_desc" %>
                <span class="search-control-panel-current">
                  Newest first
                </span>
                <span class="search-control-panel-link">
                  <%= link_to "Oldest first", search_url(query: @search_data.query, filter: @search_data.filter, sort_by: 'date_asc', results_per_page: @search_data.results_per_page, page: @search_data.current_page, expanded_types: @search_data.expanded_types, show_detailed: @search_data.show_detailed), class: "modifiable-link" %>
                </span>
              <% else %>
                <span class="search-control-panel-link">
                  <%= link_to "Newest first", search_url(query: @search_data.query, filter: @search_data.filter, sort_by: 'date_desc', results_per_page: @search_data.results_per_page, page: @search_data.current_page, expanded_types: @search_data.expanded_types, show_detailed: @search_data.show_detailed), class: "modifiable-link" %>
                </span>
                <span class="search-control-panel-current">
                  Oldest first
                </span>
              <% end %>
            </span>

          </div>
        </section>

        <div>
          <% @search_data.objects.each do |object| %>
            <%= render object.search_result_partial, object: object unless object.class == NotSupported %>
          <% end %>

          <% unless @search_data.current_page.blank? || @search_data.total_pages.blank? %>
            <p>
              Showing results
              <strong><%= @search_data.start %> - <%= [@search_data.end, @search_data.number_of_results].min %></strong>
              of
              <strong><%= number_to_delimited(@search_data.number_of_results, separator: ",") %></strong> in
              <strong>
                <%= "#{@search_data.query_time.round(3)} seconds" %>
                (<%= "#{(Time.now - @start_time).round(3)} seconds" %>).
              </strong>
            </p>
            <%= render 'pagination', user_requested_page: @search_data.current_page, last_page: @search_data.total_pages, query: @search_data.query, filter: @search_data.filter, sort_by: @search_data.sort, results_per_page: @search_data.results_per_page, expanded_types: @search_data.expanded_types_string, show_detailed: @search_data.show_detailed %>
          <% end %>
        </div>
      </div>
    </div>

  </section>
<% end %>